<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>International Cup - Pairings Display</title>
    <link rel="stylesheet" href="../css/pairings.css">
    <style>
        /* Additional display-specific styles */
        body {
            cursor: none; /* Hide cursor for clean display */
        }
    </style>
</head>
<body class="pairings-display">
    <div class="display-container">
        <div class="display-header">
            <h1>⛳ International Cup Pairings ⛳</h1>
        </div>
        
        <div class="display-content">
            <div class="day-section">
                <h2>Day 1 - Team Matches</h2>
                <div id="day1-pairings" class="pairings-grid"></div>
            </div>
            
            <div class="day-section">
                <h2>Day 2 - Singles Matches</h2>
                <div id="day2-pairings" class="pairings-grid"></div>
            </div>
        </div>
    </div>
    
    <!-- Reveal Animation Overlay -->
    <div id="reveal-overlay" class="reveal-overlay">
        <div class="reveal-content">
            <div id="reveal-usa" class="reveal-team usa">
                <div class="reveal-players"></div>
            </div>
            <div id="reveal-intl" class="reveal-team intl">
                <div class="reveal-players"></div>
            </div>
        </div>
    </div>
    
    <!-- Connection Status -->
    <div id="connection-status" class="connection-status connecting">
        Connecting...
    </div>
    
    <script>
        // Configuration
        const CONFIG = {
            REST_API_URL: 'https://qzq9gvuk9f.execute-api.us-east-1.amazonaws.com/prod',
            WEBSOCKET_URL: 'wss://kgzjvhxu6l.execute-api.us-east-1.amazonaws.com/prod'
        };
        
        let ws = null;
        let players = [];
        let pairings = [];
        let isRevealing = false;
        let currentRevealData = null;
        
        // Initialize display
        async function init() {
            await loadPlayers();
            await loadPairings();
            connectWebSocket();
        }
        
        // Load players from API
        async function loadPlayers() {
            try {
                const response = await fetch(`${CONFIG.REST_API_URL}/players`);
                const data = await response.json();
                players = data.players || [];
                console.log(`Loaded ${players.length} players`);
            } catch (error) {
                console.error('Failed to load players:', error);
            }
        }
        
        // Get player display name (abbreviated for display)
        function getPlayerName(playerId, fullName = false) {
            const player = players.find(p => p.id === playerId);
            if (!player) {
                console.log(`Player not found for ID: ${playerId}`);
                return 'TBD';
            }
            
            // Full name for reveal modal
            if (fullName) {
                const displayName = `${player.firstName} ${player.lastName}`;
                if (player.nickname) {
                    return `${displayName} (${player.nickname})`;
                }
                return displayName;
            }
            
            // Abbreviated for grid display - first initial + last name (e.g., "J. Smith")
            const firstInitial = player.firstName ? player.firstName.charAt(0).toUpperCase() : '';
            const displayName = `${firstInitial}. ${player.lastName}`;
            
            if (player.nickname) {
                return `${displayName} (${player.nickname})`;
            }
            return displayName;
        }
        
        // Load pairings from API
        async function loadPairings() {
            try {
                // Reload players first to make sure we have the latest roster
                await loadPlayers();
                
                const response = await fetch(`${CONFIG.REST_API_URL}/pairings`);
                const data = await response.json();
                
                pairings = data.pairings || [];
                console.log('Loaded pairings:', pairings.length);
                
                // Log singles matches for debugging
                const singlesMatches = pairings.filter(p => p.type === 'singles');
                console.log('Singles matches:', singlesMatches.map(p => ({
                    id: p.id,
                    usa: p.usa_player_id,
                    intl: p.intl_player_id
                })));
                
                renderPairings();
            } catch (error) {
                console.error('Failed to load pairings:', error);
            }
        }
        
        // Render pairings on screen
        function renderPairings() {
            const day1Container = document.getElementById('day1-pairings');
            const day2Container = document.getElementById('day2-pairings');
            
            day1Container.innerHTML = '';
            day2Container.innerHTML = '';
            
            pairings.forEach(pairing => {
                const card = createPairingCard(pairing);
                
                if (pairing.day === 1) {
                    day1Container.appendChild(card);
                } else {
                    day2Container.appendChild(card);
                }
                
                // Show fully revealed pairings (step 2)
                if (pairing.revealStep === 2) {
                    setTimeout(() => card.classList.add('revealed'), 100);
                }
            });
        }
        
        // Create pairing card element
        function createPairingCard(pairing) {
            const card = document.createElement('div');
            card.className = 'pairing-card';
            card.dataset.pairingId = pairing.id;
            
            if (pairing.type === 'team') {
                const usaPlayer1 = getPlayerName(pairing.usa_team.player1_id);
                const usaPlayer2 = getPlayerName(pairing.usa_team.player2_id);
                const intlPlayer1 = getPlayerName(pairing.intl_team.player1_id);
                const intlPlayer2 = getPlayerName(pairing.intl_team.player2_id);
                
                card.innerHTML = `
                    <div class="match-number">Match ${pairing.match_number}</div>
                    <div class="pairing-matchup">
                        <div class="team-side usa">
                            <div class="player-name">${usaPlayer1}</div>
                            <div class="player-name">${usaPlayer2}</div>
                        </div>
                        <div class="vs-divider">VS</div>
                        <div class="team-side intl">
                            <div class="player-name">${intlPlayer1}</div>
                            <div class="player-name">${intlPlayer2}</div>
                        </div>
                    </div>
                `;
            } else {
                const usaPlayer = getPlayerName(pairing.usa_player_id);
                const intlPlayer = getPlayerName(pairing.intl_player_id);
                
                card.innerHTML = `
                    <div class="match-number">Match ${pairing.match_number}</div>
                    <div class="pairing-matchup">
                        <div class="team-side usa">
                            <div class="player-name">${usaPlayer}</div>
                        </div>
                        <div class="vs-divider">VS</div>
                        <div class="team-side intl">
                            <div class="player-name">${intlPlayer}</div>
                        </div>
                    </div>
                `;
            }
            
            return card;
        }
        
        // Connect to WebSocket
        function connectWebSocket() {
            updateConnectionStatus('connecting');
            
            ws = new WebSocket(CONFIG.WEBSOCKET_URL);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus('connected');
                setTimeout(() => {
                    document.getElementById('connection-status').style.display = 'none';
                }, 2000);
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('disconnected');
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus('disconnected');
                // Reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            console.log('WebSocket message:', message);
            
            if (message.type === 'reveal') {
                handleRevealMessage(message);
            } else if (message.type === 'reset') {
                resetDisplay();
            }
        }
        
        // Handle reveal message with step
        async function handleRevealMessage(message) {
            const { pairing, step, side } = message;
            
            console.log('Reveal message received:', {
                pairingId: pairing.id,
                type: pairing.type,
                step: step,
                side: side,
                usa_player_id: pairing.usa_player_id,
                intl_player_id: pairing.intl_player_id
            });
            
            // Update local pairing data
            const localPairing = pairings.find(p => p.id === pairing.id);
            if (localPairing) {
                localPairing.revealStep = step;
            }
            
            if (step === 1) {
                // Show first side only
                await revealFirstSide(pairing, side);
            } else if (step === 2) {
                // Show second side and complete reveal
                await revealSecondSide(pairing, side);
            }
        }
        
        // Reveal first side only
        async function revealFirstSide(pairing, side) {
            if (isRevealing) return;
            isRevealing = true;
            
            const overlay = document.getElementById('reveal-overlay');
            const usaTeam = document.getElementById('reveal-usa');
            const intlTeam = document.getElementById('reveal-intl');
            
            // Clear previous content
            usaTeam.classList.remove('show');
            intlTeam.classList.remove('show');
            
            // Show overlay
            overlay.classList.add('active');
            
            // Prepare content for the side to reveal
            if (side === 'usa') {
                if (pairing.type === 'team') {
                    const player1 = getPlayerName(pairing.usa_team.player1_id, true);
                    const player2 = getPlayerName(pairing.usa_team.player2_id, true);
                    usaTeam.querySelector('.reveal-players').innerHTML = `
                        <div>${player1}</div>
                        <div>${player2}</div>
                    `;
                } else {
                    const player = getPlayerName(pairing.usa_player_id, true);
                    usaTeam.querySelector('.reveal-players').innerHTML = `<div>${player}</div>`;
                }
                
                // Animate USA team
                await new Promise(resolve => {
                    setTimeout(() => {
                        usaTeam.classList.add('show');
                        resolve();
                    }, 300);
                });
            } else {
                if (pairing.type === 'team') {
                    const player1 = getPlayerName(pairing.intl_team.player1_id, true);
                    const player2 = getPlayerName(pairing.intl_team.player2_id, true);
                    intlTeam.querySelector('.reveal-players').innerHTML = `
                        <div>${player1}</div>
                        <div>${player2}</div>
                    `;
                } else {
                    const player = getPlayerName(pairing.intl_player_id, true);
                    intlTeam.querySelector('.reveal-players').innerHTML = `<div>${player}</div>`;
                }
                
                // Animate International team
                await new Promise(resolve => {
                    setTimeout(() => {
                        intlTeam.classList.add('show');
                        resolve();
                    }, 300);
                });
            }
            
            // Store current reveal data
            currentRevealData = { pairing, firstSide: side };
            
            isRevealing = false;
        }
        
        // Reveal second side and complete
        async function revealSecondSide(pairing, side) {
            if (isRevealing) return;
            isRevealing = true;
            
            const overlay = document.getElementById('reveal-overlay');
            const usaTeam = document.getElementById('reveal-usa');
            const intlTeam = document.getElementById('reveal-intl');
            
            // The opposite side from step 1
            if (side === 'usa') {
                if (pairing.type === 'team') {
                    const player1 = getPlayerName(pairing.usa_team.player1_id, true);
                    const player2 = getPlayerName(pairing.usa_team.player2_id, true);
                    usaTeam.querySelector('.reveal-players').innerHTML = `
                        <div>${player1}</div>
                        <div>${player2}</div>
                    `;
                } else {
                    const player = getPlayerName(pairing.usa_player_id, true);
                    usaTeam.querySelector('.reveal-players').innerHTML = `<div>${player}</div>`;
                }
                
                // Animate USA team
                await new Promise(resolve => {
                    setTimeout(() => {
                        usaTeam.classList.add('show');
                        resolve();
                    }, 300);
                });
            } else {
                if (pairing.type === 'team') {
                    const player1 = getPlayerName(pairing.intl_team.player1_id, true);
                    const player2 = getPlayerName(pairing.intl_team.player2_id, true);
                    intlTeam.querySelector('.reveal-players').innerHTML = `
                        <div>${player1}</div>
                        <div>${player2}</div>
                    `;
                } else {
                    const player = getPlayerName(pairing.intl_player_id, true);
                    intlTeam.querySelector('.reveal-players').innerHTML = `<div>${player}</div>`;
                }
                
                // Animate International team
                await new Promise(resolve => {
                    setTimeout(() => {
                        intlTeam.classList.add('show');
                        resolve();
                    }, 300);
                });
            }
            
            // Hold both sides on screen for 3 seconds
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Hide overlay
            await new Promise(resolve => {
                overlay.classList.remove('active');
                usaTeam.classList.remove('show');
                intlTeam.classList.remove('show');
                setTimeout(resolve, 500);
            });
            
            // Add to grid
            const card = document.querySelector(`[data-pairing-id="${pairing.id}"]`);
            if (card) {
                card.classList.add('revealed');
            }
            
            currentRevealData = null;
            isRevealing = false;
        }
        
        // Reset display
        function resetDisplay() {
            const cards = document.querySelectorAll('.pairing-card');
            cards.forEach(card => card.classList.remove('revealed'));
            
            // Hide overlay
            const overlay = document.getElementById('reveal-overlay');
            const usaTeam = document.getElementById('reveal-usa');
            const intlTeam = document.getElementById('reveal-intl');
            
            overlay.classList.remove('active');
            usaTeam.classList.remove('show');
            intlTeam.classList.remove('show');
            
            currentRevealData = null;
            isRevealing = false;
            
            // Reload pairings to get reset state
            loadPairings();
        }
        
        // Update connection status
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = `connection-status ${status}`;
            
            const statusText = {
                connecting: 'Connecting...',
                connected: 'Connected ✓',
                disconnected: 'Disconnected - Reconnecting...'
            };
            
            statusEl.textContent = statusText[status] || status;
            
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 2000);
            } else {
                statusEl.style.display = 'block';
            }
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
        
        // Reload pairings every 30 seconds as fallback
        setInterval(loadPairings, 30000);
        
        // Reload players every 5 minutes
        setInterval(loadPlayers, 300000);
    </script>
</body>
</html>
