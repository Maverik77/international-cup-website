<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>International Cup - Pairings Admin</title>
    <link rel="stylesheet" href="../css/pairings.css">
</head>
<body class="pairings-admin">
    <div class="admin-container">
        <div class="admin-header">
            <h1>‚õ≥ International Cup - Pairings Admin</h1>
            <p>Manage player roster, pairings, and control reveal sequence</p>
        </div>
        
        <!-- Password Section -->
        <div id="password-section" class="password-section">
            <h2>Admin Access</h2>
            <p>Enter admin password to manage pairings</p>
            <input type="password" id="admin-password" placeholder="Enter password">
            <button class="btn btn-primary" onclick="login()">Login</button>
            <p id="password-error" style="color: red; margin-top: 10px;"></p>
        </div>
        
        <!-- Main Admin Interface (hidden until authenticated) -->
        <div id="admin-interface" style="display: none;">
            
            <!-- Player Roster Management -->
            <div class="roster-management collapsed">
                <div class="roster-header" onclick="toggleRoster()">
                    <h2>Player Roster Management</h2>
                    <span class="roster-collapse-icon">‚ñº</span>
                </div>
                
                <div class="roster-content">
                    <p style="margin-bottom: 15px; padding: 0 20px;">Manage all players for Team USA and International team</p>
                    
                    <!-- Tabs -->
                    <div class="roster-tabs">
                        <button class="roster-tab usa active" onclick="switchRosterTab('usa')">
                            üá∫üá∏ Team USA (<span id="usa-count">0</span>)
                        </button>
                        <button class="roster-tab intl" onclick="switchRosterTab('intl')">
                            üåç Team International (<span id="intl-count">0</span>)
                        </button>
                    </div>
                    
                    <!-- USA Tab Content -->
                    <div id="roster-tab-usa" class="roster-tab-content active" style="padding: 0 20px 20px;">
                        <div id="usa-players" class="player-list"></div>
                        <button class="btn-add-player" onclick="addPlayer('USA')">+ Add USA Player</button>
                    </div>
                    
                    <!-- International Tab Content -->
                    <div id="roster-tab-intl" class="roster-tab-content" style="padding: 0 20px 20px;">
                        <div id="intl-players" class="player-list"></div>
                        <button class="btn-add-player" onclick="addPlayer('International')">+ Add International Player</button>
                    </div>
                    
                    <div style="padding: 0 20px 20px;">
                        <button class="btn btn-success" onclick="saveRoster()">Save Roster</button>
                        <button class="btn btn-secondary" onclick="loadSampleRoster()">Load Sample Data</button>
                    </div>
                </div>
            </div>
            
            <!-- Global Controls Section -->
            <div class="controls-section">
                <h2>Global Controls</h2>
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="revealAll()">Reveal All Pairings</button>
                    <button class="btn btn-warning" onclick="resetAllReveals()">Reset All Reveals</button>
                    <button class="btn btn-danger" onclick="resetAllPairings()">Reset All Pairings</button>
                    <button class="btn btn-success" onclick="saveAllPairings()">Save All Pairings</button>
                    <button class="btn btn-secondary" onclick="initializeEmptyPairings()">Initialize Empty Pairings</button>
                </div>
                
                <div class="status-display">
                    <p><strong>Status:</strong> <span id="global-status">Ready</span></p>
                    <p><strong>Players Loaded:</strong> <span id="player-count">0</span></p>
                </div>
            </div>
            
            <!-- Day 1 Team Matches Editor -->
            <div class="pairings-editor">
                <h2>Day 1 - Team Matches (12 Matches)</h2>
                <div id="day1-editor"></div>
            </div>
            
            <!-- Day 2 Singles Matches Editor -->
            <div class="pairings-editor">
                <h2>Day 2 - Singles Matches (24 Matches)</h2>
                <div id="day2-editor"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const CONFIG = {
            REST_API_URL: 'https://qzq9gvuk9f.execute-api.us-east-1.amazonaws.com/prod',
            WEBSOCKET_URL: 'wss://kgzjvhxu6l.execute-api.us-east-1.amazonaws.com/prod'
        };
        
        let adminPassword = '';
        let players = [];
        let pairings = [];
        let playerIdCounter = { USA: 1, International: 1 };
        
        // Check for saved password
        function checkSavedPassword() {
            const saved = localStorage.getItem('icup_admin_password');
            if (saved) {
                adminPassword = saved;
                document.getElementById('admin-password').value = saved;
                login();
            }
        }
        
        // Login function
        async function login() {
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('password-error');
            
            if (!password) {
                errorEl.textContent = 'Please enter a password';
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.REST_API_URL}/players`, {
                    headers: {
                        'X-Admin-Password': password
                    }
                });
                
                if (response.ok) {
                    adminPassword = password;
                    localStorage.setItem('icup_admin_password', password);
                    document.getElementById('password-section').style.display = 'none';
                    document.getElementById('admin-interface').style.display = 'block';
                    await loadPlayers();
                    await loadPairings();
                } else {
                    errorEl.textContent = 'Invalid password';
                }
            } catch (error) {
                errorEl.textContent = 'Connection error - check API configuration';
                console.error('Login error:', error);
            }
        }
        
        // Load players from API
        async function loadPlayers() {
            try {
                const response = await fetch(`${CONFIG.REST_API_URL}/players`);
                const data = await response.json();
                
                players = data.players || [];
                
                // Update counter for next player ID
                const usaPlayers = players.filter(p => p.team === 'USA');
                const intlPlayers = players.filter(p => p.team === 'International');
                
                if (usaPlayers.length > 0) {
                    const maxId = Math.max(...usaPlayers.map(p => parseInt(p.id.split('-')[2])));
                    playerIdCounter.USA = maxId + 1;
                }
                
                if (intlPlayers.length > 0) {
                    const maxId = Math.max(...intlPlayers.map(p => parseInt(p.id.split('-')[2])));
                    playerIdCounter.International = maxId + 1;
                }
                
                renderRoster();
                updatePlayerCount();
            } catch (error) {
                console.error('Failed to load players:', error);
            }
        }
        
        // Render roster UI
        function renderRoster() {
            const usaContainer = document.getElementById('usa-players');
            const intlContainer = document.getElementById('intl-players');
            
            usaContainer.innerHTML = '';
            intlContainer.innerHTML = '';
            
            const usaPlayers = players.filter(p => p.team === 'USA');
            const intlPlayers = players.filter(p => p.team === 'International');
            
            usaPlayers.forEach(player => {
                usaContainer.appendChild(createPlayerItem(player));
            });
            
            intlPlayers.forEach(player => {
                intlContainer.appendChild(createPlayerItem(player));
            });
            
            // Update counts
            document.getElementById('usa-count').textContent = usaPlayers.length;
            document.getElementById('intl-count').textContent = intlPlayers.length;
        }
        
        // Create player item element
        function createPlayerItem(player) {
            const div = document.createElement('div');
            div.className = `player-item ${player.team.toLowerCase()}`;
            div.dataset.playerId = player.id;
            
            div.innerHTML = `
                <div class="player-inputs">
                    <input type="text" placeholder="First Name" 
                           value="${player.firstName || ''}" 
                           onchange="updatePlayerField('${player.id}', 'firstName', this.value)">
                    <input type="text" placeholder="Last Name" 
                           value="${player.lastName || ''}" 
                           onchange="updatePlayerField('${player.id}', 'lastName', this.value)">
                    <input type="text" placeholder="Nickname (optional)" 
                           value="${player.nickname || ''}" 
                           onchange="updatePlayerField('${player.id}', 'nickname', this.value)">
                    <select onchange="updatePlayerField('${player.id}', 'teeColor', this.value)">
                        <option value="Blue" ${player.teeColor === 'Blue' ? 'selected' : ''}>Blue Tees</option>
                        <option value="White" ${player.teeColor === 'White' ? 'selected' : ''}>White Tees</option>
                    </select>
                    <button class="btn-delete" onclick="deletePlayer('${player.id}')">Delete</button>
                </div>
            `;
            
            return div;
        }
        
        // Add new player
        function addPlayer(team) {
            const id = `player-${team.toLowerCase().substring(0, 4)}-${playerIdCounter[team]}`;
            playerIdCounter[team]++;
            
            const player = {
                id: id,
                firstName: '',
                lastName: '',
                nickname: '',
                team: team,
                teeColor: 'Blue'
            };
            
            players.push(player);
            renderRoster();
            updatePlayerCount();
        }
        
        // Update player field
        function updatePlayerField(playerId, field, value) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                player[field] = value;
            }
        }
        
        // Delete player
        function deletePlayer(playerId) {
            if (!confirm('Delete this player?')) return;
            
            players = players.filter(p => p.id !== playerId);
            renderRoster();
            updatePlayerCount();
            
            // Check if this player is used in any pairings and warn
            const isUsed = pairings.some(pairing => {
                if (pairing.type === 'team') {
                    return pairing.usa_team.player1_id === playerId ||
                           pairing.usa_team.player2_id === playerId ||
                           pairing.intl_team.player1_id === playerId ||
                           pairing.intl_team.player2_id === playerId;
                } else {
                    return pairing.usa_player_id === playerId ||
                           pairing.intl_player_id === playerId;
                }
            });
            
            if (isUsed) {
                alert('Warning: This player is assigned to matches. Save roster to clear those assignments.');
            }
        }
        
        // Save roster to API
        async function saveRoster() {
            try {
                document.getElementById('global-status').textContent = 'Saving roster...';
                
                const response = await fetch(`${CONFIG.REST_API_URL}/players`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({ players })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('global-status').textContent = `Saved ${data.count} players`;
                    await loadPlayers();
                    
                    // Re-render editors to update dropdowns with new player names
                    renderEditors();
                    
                    setTimeout(() => {
                        document.getElementById('global-status').textContent = 'Ready';
                    }, 2000);
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Save roster error:', error);
                alert('Failed to save roster');
                document.getElementById('global-status').textContent = 'Save failed';
            }
        }
        
        // Load sample roster
        function loadSampleRoster() {
            if (!confirm('Load sample roster? This will overwrite current players.')) return;
            
            players = [
                // USA Team - 24 players
                { id: 'player-usa-1', firstName: 'John', lastName: 'Altman', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-2', firstName: 'Keith', lastName: 'Barnes', nickname: '', team: 'USA', teeColor: 'White' },
                { id: 'player-usa-3', firstName: 'Jay', lastName: 'Collins', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-4', firstName: 'Norm', lastName: 'Corkhill', nickname: '', team: 'USA', teeColor: 'White' },
                { id: 'player-usa-5', firstName: 'Scott', lastName: 'Covino', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-6', firstName: 'Chris', lastName: 'Crouse', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-7', firstName: 'Bob', lastName: 'Gallo', nickname: '', team: 'USA', teeColor: 'White' },
                { id: 'player-usa-8', firstName: 'Mike', lastName: 'Edelheit', nickname: '', team: 'USA', teeColor: 'White' },
                { id: 'player-usa-9', firstName: 'Victor', lastName: 'Esposito', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-10', firstName: 'Mitch', lastName: 'Freedman', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-11', firstName: 'Jeff', lastName: 'Galkin', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-12', firstName: 'Jamie', lastName: 'Kerrigan', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-13', firstName: 'Dave', lastName: 'Kohlasch', nickname: '', team: 'USA', teeColor: 'White' },
                { id: 'player-usa-14', firstName: 'Kevin', lastName: 'Kozlowski', nickname: '', team: 'USA', teeColor: 'White' },
                { id: 'player-usa-15', firstName: 'Jeff', lastName: 'Kritsberg', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-16', firstName: 'Kyle', lastName: 'Lenihan', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-17', firstName: 'Mike', lastName: 'McNamee', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-18', firstName: 'Greg', lastName: 'Parda', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-19', firstName: 'Pete', lastName: 'Mitesser', nickname: '', team: 'USA', teeColor: 'White' },
                { id: 'player-usa-20', firstName: 'Tom', lastName: 'Murphy', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-21', firstName: 'Anthony', lastName: 'Rizzo', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-22', firstName: 'Brett', lastName: 'Sutch', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-23', firstName: 'Jay', lastName: 'Vosburgh', nickname: '', team: 'USA', teeColor: 'Blue' },
                { id: 'player-usa-24', firstName: 'Mike', lastName: 'Ziegler', nickname: '', team: 'USA', teeColor: 'Blue' },
                // International Team - 24 players
                { id: 'player-intl-1', firstName: 'Tim', lastName: 'Pearce', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-2', firstName: 'Phil', lastName: 'Woodisse', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-3', firstName: 'Erik', lastName: 'Wagner', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-4', firstName: 'Daren', lastName: 'Wickham', nickname: '', team: 'International', teeColor: 'White' },
                { id: 'player-intl-5', firstName: 'Rhys', lastName: 'Gully', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-6', firstName: 'Troy', lastName: 'Hazzard', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-7', firstName: 'Uttam', lastName: 'Bharwani', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-8', firstName: 'Philip', lastName: 'Olivero', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-9', firstName: 'Robbie', lastName: 'Neilson', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-10', firstName: 'Phillip', lastName: 'Jewell', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-11', firstName: 'Ben', lastName: 'Hedges', nickname: '', team: 'International', teeColor: 'White' },
                { id: 'player-intl-12', firstName: 'Stefan', lastName: 'Lambert', nickname: '', team: 'International', teeColor: 'White' },
                { id: 'player-intl-13', firstName: 'Jun', lastName: 'Bae', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-14', firstName: 'Joung Kook', lastName: 'Park', nickname: 'JK', team: 'International', teeColor: 'White' },
                { id: 'player-intl-15', firstName: 'Yunsang', lastName: 'Bae', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-16', firstName: 'Jack', lastName: 'Silpacharn', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-17', firstName: 'James', lastName: 'Siu', nickname: '', team: 'International', teeColor: 'White' },
                { id: 'player-intl-18', firstName: 'Jong', lastName: 'Kim', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-19', firstName: 'Vijay', lastName: 'Davuluri', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-20', firstName: 'Suresh', lastName: 'Saribala', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-21', firstName: 'Muralidhar', lastName: 'Malyala', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-22', firstName: 'Anil B', lastName: 'Katarki', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-23', firstName: 'Dinakar', lastName: 'Kudum', nickname: '', team: 'International', teeColor: 'Blue' },
                { id: 'player-intl-24', firstName: 'Soban', lastName: 'Ansari', nickname: '', team: 'International', teeColor: 'Blue' }
            ];
            
            playerIdCounter = { USA: 25, International: 25 };
            renderRoster();
            updatePlayerCount();
            alert('Sample roster loaded. Click "Save Roster" to persist.');
        }
        
        // Update player count display
        function updatePlayerCount() {
            const count = players.length;
            document.getElementById('player-count').textContent = count;
        }
        
        // Load pairings from API
        async function loadPairings() {
            try {
                const response = await fetch(`${CONFIG.REST_API_URL}/pairings`);
                const data = await response.json();
                
                pairings = data.pairings || [];
                
                if (pairings.length === 0) {
                    initializeEmptyPairings();
                } else {
                    renderEditors();
                }
            } catch (error) {
                console.error('Failed to load pairings:', error);
                initializeEmptyPairings();
            }
        }
        
        // Initialize empty pairings structure
        function initializeEmptyPairings() {
            pairings = [];
            
            // Day 1: 12 team matches - alternating reveal order
            for (let i = 1; i <= 12; i++) {
                pairings.push({
                    id: `day1-team-${i}`,
                    type: 'team',
                    day: 1,
                    match_number: i,
                    usa_team: { player1_id: '', player2_id: '' },
                    intl_team: { player1_id: '', player2_id: '' },
                    revealOrder: i % 2 === 1 ? 'usa-first' : 'intl-first',
                    revealStep: 0
                });
            }
            
            // Day 2: 24 singles matches - alternating reveal order
            for (let i = 1; i <= 24; i++) {
                pairings.push({
                    id: `day2-singles-${i}`,
                    type: 'singles',
                    day: 2,
                    match_number: i,
                    usa_player_id: '',
                    intl_player_id: '',
                    revealOrder: i % 2 === 1 ? 'usa-first' : 'intl-first',
                    revealStep: 0
                });
            }
            
            renderEditors();
        }
        
        // Render pairing editors
        function renderEditors() {
            const day1Editor = document.getElementById('day1-editor');
            const day2Editor = document.getElementById('day2-editor');
            
            day1Editor.innerHTML = '';
            day2Editor.innerHTML = '';
            
            pairings.forEach(pairing => {
                const card = createEditorCard(pairing);
                
                if (pairing.day === 1) {
                    day1Editor.appendChild(card);
                } else {
                    day2Editor.appendChild(card);
                }
            });
        }
        
        // Create editor card
        function createEditorCard(pairing) {
            const card = document.createElement('div');
            card.className = 'pairing-edit-card';
            if (pairing.revealStep === 2) {
                card.classList.add('collapsed');
            }
            card.dataset.pairingId = pairing.id;
            
            const statusClass = pairing.revealStep === 0 ? 'not-started' : 
                                pairing.revealStep === 1 ? 'step-1' : 'step-2';
            const statusText = pairing.revealStep === 0 ? 'Not Started' :
                              pairing.revealStep === 1 ? 'Side 1 Revealed' : 'Both Revealed';
            
            if (pairing.type === 'team') {
                card.innerHTML = `
                    <div class="pairing-card-header" onclick="togglePairingCard('${pairing.id}')">
                        <h3>Match ${pairing.match_number}</h3>
                        <div class="reveal-status ${statusClass}">${statusText}</div>
                    </div>
                    
                    <div class="pairing-card-content">
                        <div class="reveal-order-controls">
                            <label><input type="radio" name="order-${pairing.id}" value="usa-first" 
                                   ${pairing.revealOrder === 'usa-first' ? 'checked' : ''}
                                   onchange="updateRevealOrder('${pairing.id}', 'usa-first')"> USA First</label>
                            <label><input type="radio" name="order-${pairing.id}" value="intl-first"
                                   ${pairing.revealOrder === 'intl-first' ? 'checked' : ''}
                                   onchange="updateRevealOrder('${pairing.id}', 'intl-first')"> International First</label>
                        </div>
                        
                        <div class="team-inputs">
                            <div class="input-group usa">
                                <label>USA Player 1</label>
                                ${createPlayerDropdown(pairing.usa_team.player1_id, 'USA', pairing.id, 'usa_team.player1_id')}
                            </div>
                            <div class="input-group intl">
                                <label>International Player 1</label>
                                ${createPlayerDropdown(pairing.intl_team.player1_id, 'International', pairing.id, 'intl_team.player1_id')}
                            </div>
                            <div class="input-group usa">
                                <label>USA Player 2</label>
                                ${createPlayerDropdown(pairing.usa_team.player2_id, 'USA', pairing.id, 'usa_team.player2_id')}
                            </div>
                            <div class="input-group intl">
                                <label>International Player 2</label>
                                ${createPlayerDropdown(pairing.intl_team.player2_id, 'International', pairing.id, 'intl_team.player2_id')}
                            </div>
                        </div>
                        
                        <div class="pairing-actions">
                            <button class="btn-reveal-step" onclick="revealStep('${pairing.id}')" 
                                    ${pairing.revealStep >= 2 ? 'disabled' : ''}>
                                ${pairing.revealStep === 0 ? 'Reveal First Side' : 
                                  pairing.revealStep === 1 ? 'Reveal Second Side' : 'Fully Revealed'}
                            </button>
                            <button class="btn-save-pairing" onclick="saveSinglePairing('${pairing.id}')">Save This Match</button>
                        </div>
                    </div>
                `;
            } else {
                card.innerHTML = `
                    <div class="pairing-card-header" onclick="togglePairingCard('${pairing.id}')">
                        <h3>Match ${pairing.match_number}</h3>
                        <div class="reveal-status ${statusClass}">${statusText}</div>
                    </div>
                    
                    <div class="pairing-card-content">
                        <div class="reveal-order-controls">
                            <label><input type="radio" name="order-${pairing.id}" value="usa-first"
                                   ${pairing.revealOrder === 'usa-first' ? 'checked' : ''}
                                   onchange="updateRevealOrder('${pairing.id}', 'usa-first')"> USA First</label>
                            <label><input type="radio" name="order-${pairing.id}" value="intl-first"
                                   ${pairing.revealOrder === 'intl-first' ? 'checked' : ''}
                                   onchange="updateRevealOrder('${pairing.id}', 'intl-first')"> International First</label>
                        </div>
                        
                        <div class="singles-inputs">
                            <div class="input-group usa">
                                <label>USA Player</label>
                                ${createPlayerDropdown(pairing.usa_player_id, 'USA', pairing.id, 'usa_player_id')}
                            </div>
                            <div class="input-group intl">
                                <label>International Player</label>
                                ${createPlayerDropdown(pairing.intl_player_id, 'International', pairing.id, 'intl_player_id')}
                            </div>
                        </div>
                        
                        <div class="pairing-actions">
                            <button class="btn-reveal-step" onclick="revealStep('${pairing.id}')"
                                    ${pairing.revealStep >= 2 ? 'disabled' : ''}>
                                ${pairing.revealStep === 0 ? 'Reveal First Side' :
                                  pairing.revealStep === 1 ? 'Reveal Second Side' : 'Fully Revealed'}
                            </button>
                            ${pairing.revealStep === 0 ? 
                                '<button class="btn-reveal-both" onclick="revealBoth(\'' + pairing.id + '\')">Reveal Both</button>' : ''}
                            <button class="btn-save-pairing" onclick="saveSinglePairing('${pairing.id}')">Save This Match</button>
                        </div>
                    </div>
                `;
            }
            
            // Add event listeners for dropdowns
            card.querySelectorAll('select').forEach(select => {
                const pairingId = select.dataset.pairingId;
                const field = select.dataset.field;
                select.addEventListener('change', (e) => {
                    updatePairingPlayer(pairingId, field, e.target.value);
                });
            });
            
            return card;
        }
        
        // Toggle pairing card collapse
        function togglePairingCard(pairingId) {
            const card = document.querySelector(`[data-pairing-id="${pairingId}"]`);
            if (card) {
                card.classList.toggle('collapsed');
            }
        }
        
        // Save single pairing
        async function saveSinglePairing(pairingId) {
            const pairing = pairings.find(p => p.id === pairingId);
            if (!pairing) return;
            
            try {
                const card = document.querySelector(`[data-pairing-id="${pairingId}"]`);
                const saveBtn = card.querySelector('.btn-save-pairing');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'Saving...';
                saveBtn.disabled = true;
                
                const response = await fetch(`${CONFIG.REST_API_URL}/pairings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({ pairings })
                });
                
                if (response.ok) {
                    saveBtn.textContent = '‚úì Saved!';
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                    }, 1500);
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Save pairing error:', error);
                alert('Failed to save pairing');
                const card = document.querySelector(`[data-pairing-id="${pairingId}"]`);
                const saveBtn = card.querySelector('.btn-save-pairing');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save This Match';
            }
        }
        
        // Create player dropdown HTML with smart filtering
        function createPlayerDropdown(selectedId, team, pairingId, field) {
            const pairing = pairings.find(p => p.id === pairingId);
            const teamPlayers = players.filter(p => p.team === team);
            
            // Get all player IDs used on this day (excluding current pairing and current field)
            const usedPlayerIds = getUsedPlayerIdsForDay(pairing.day, pairingId, field);
            
            const selectId = 'select-' + Math.random().toString(36).substr(2, 9);
            
            let html = `<select id="${selectId}" data-pairing-id="${pairingId}" data-field="${field}">`;
            html += '<option value="">-- Select Player --</option>';
            
            teamPlayers.forEach(player => {
                const displayName = player.nickname ? 
                    `${player.firstName} ${player.lastName} (${player.nickname})` :
                    `${player.firstName} ${player.lastName}`;
                const selected = player.id === selectedId ? 'selected' : '';
                const disabled = usedPlayerIds.includes(player.id) ? 'disabled' : '';
                const style = disabled ? 'color: #999; font-style: italic;' : '';
                
                html += `<option value="${player.id}" ${selected} ${disabled} style="${style}">${displayName}${disabled ? ' (assigned)' : ''}</option>`;
            });
            
            html += '</select>';
            return html;
        }
        
        // Get player IDs already used on a specific day
        function getUsedPlayerIdsForDay(day, excludePairingId, excludeField) {
            const usedIds = new Set();
            
            pairings.forEach(pairing => {
                if (pairing.day !== day || pairing.id === excludePairingId) {
                    return;
                }
                
                if (pairing.type === 'team') {
                    if (pairing.usa_team.player1_id) usedIds.add(pairing.usa_team.player1_id);
                    if (pairing.usa_team.player2_id) usedIds.add(pairing.usa_team.player2_id);
                    if (pairing.intl_team.player1_id) usedIds.add(pairing.intl_team.player1_id);
                    if (pairing.intl_team.player2_id) usedIds.add(pairing.intl_team.player2_id);
                } else {
                    if (pairing.usa_player_id) usedIds.add(pairing.usa_player_id);
                    if (pairing.intl_player_id) usedIds.add(pairing.intl_player_id);
                }
            });
            
            // Also exclude players used in the same match (current pairing)
            const currentPairing = pairings.find(p => p.id === excludePairingId);
            if (currentPairing) {
                if (currentPairing.type === 'team') {
                    ['usa_team.player1_id', 'usa_team.player2_id', 'intl_team.player1_id', 'intl_team.player2_id'].forEach(f => {
                        if (f !== excludeField) {
                            const [obj, prop] = f.split('.');
                            const id = currentPairing[obj][prop];
                            if (id) usedIds.add(id);
                        }
                    });
                } else {
                    ['usa_player_id', 'intl_player_id'].forEach(f => {
                        if (f !== excludeField) {
                            const id = currentPairing[f];
                            if (id) usedIds.add(id);
                        }
                    });
                }
            }
            
            return Array.from(usedIds);
        }
        
        // Update pairing player
        function updatePairingPlayer(pairingId, field, value) {
            const pairing = pairings.find(p => p.id === pairingId);
            if (!pairing) return;
            
            if (field.includes('.')) {
                const [obj, prop] = field.split('.');
                pairing[obj][prop] = value;
            } else {
                pairing[field] = value;
            }
            
            // Save scroll position before re-rendering
            const scrollY = window.scrollY;
            
            // Re-render all editors to update dropdown availability
            renderEditors();
            
            // Restore scroll position after re-rendering
            window.scrollTo(0, scrollY);
        }
        
        // Update reveal order
        function updateRevealOrder(pairingId, order) {
            const pairing = pairings.find(p => p.id === pairingId);
            if (pairing) {
                pairing.revealOrder = order;
            }
        }
        
        // Reveal step
        async function revealStep(pairingId) {
            const pairing = pairings.find(p => p.id === pairingId);
            if (!pairing) return;
            
            const nextStep = pairing.revealStep + 1;
            if (nextStep > 2) return;
            
            try {
                const response = await fetch(`${CONFIG.REST_API_URL}/reveal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({
                        action: 'reveal',
                        pairingId: pairingId,
                        step: nextStep
                    })
                });
                
                if (response.ok) {
                    pairing.revealStep = nextStep;
                    renderEditors();
                    
                    // Auto-collapse when fully revealed (step 2)
                    if (nextStep === 2) {
                        setTimeout(() => {
                            const card = document.querySelector(`[data-pairing-id="${pairingId}"]`);
                            if (card && !card.classList.contains('collapsed')) {
                                card.classList.add('collapsed');
                            }
                        }, 500);
                    }
                } else {
                    throw new Error('Reveal failed');
                }
            } catch (error) {
                console.error('Reveal error:', error);
                alert('Failed to reveal pairing');
            }
        }
        
        // Reveal both sides of a single pairing
        async function revealBoth(pairingId) {
            const pairing = pairings.find(p => p.id === pairingId);
            if (!pairing || pairing.revealStep !== 0) return;
            
            try {
                // Reveal step 1 (first side)
                await fetch(`${CONFIG.REST_API_URL}/reveal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({
                        action: 'reveal',
                        pairingId: pairingId,
                        step: 1
                    })
                });
                pairing.revealStep = 1;
                renderEditors();
                
                // Wait 2 seconds before revealing second side
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Reveal step 2 (second side)
                await fetch(`${CONFIG.REST_API_URL}/reveal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({
                        action: 'reveal',
                        pairingId: pairingId,
                        step: 2
                    })
                });
                pairing.revealStep = 2;
                renderEditors();
                
                // Auto-collapse after reveal
                setTimeout(() => {
                    const card = document.querySelector(`[data-pairing-id="${pairingId}"]`);
                    if (card && !card.classList.contains('collapsed')) {
                        card.classList.add('collapsed');
                    }
                }, 500);
            } catch (error) {
                console.error('Reveal both error:', error);
                alert('Failed to reveal pairing');
            }
        }
        
        // Reveal all pairings sequentially
        async function revealAll() {
            const statusEl = document.getElementById('global-status');
            
            // Get all pairings that are not fully revealed, sorted by day and match number
            const pairingsToReveal = pairings
                .filter(p => p.revealStep < 2)
                .sort((a, b) => {
                    if (a.day !== b.day) return a.day - b.day;
                    return a.match_number - b.match_number;
                });
            
            if (pairingsToReveal.length === 0) {
                alert('All pairings are already revealed!');
                return;
            }
            
            if (!confirm(`This will reveal ${pairingsToReveal.length} pairings. Continue?`)) {
                return;
            }
            
            statusEl.textContent = `Revealing pairings...`;
            
            for (let i = 0; i < pairingsToReveal.length; i++) {
                const pairing = pairingsToReveal[i];
                statusEl.textContent = `Revealing Match ${pairing.match_number} (${i + 1}/${pairingsToReveal.length})...`;
                
                try {
                    // Reveal step 1 (first side)
                    if (pairing.revealStep === 0) {
                        await fetch(`${CONFIG.REST_API_URL}/reveal`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Admin-Password': adminPassword
                            },
                            body: JSON.stringify({
                                action: 'reveal',
                                pairingId: pairing.id,
                                step: 1
                            })
                        });
                        pairing.revealStep = 1;
                        renderEditors();
                        
                        // Wait 2 seconds before revealing second side
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                    
                    // Reveal step 2 (second side)
                    if (pairing.revealStep === 1) {
                        await fetch(`${CONFIG.REST_API_URL}/reveal`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Admin-Password': adminPassword
                            },
                            body: JSON.stringify({
                                action: 'reveal',
                                pairingId: pairing.id,
                                step: 2
                            })
                        });
                        pairing.revealStep = 2;
                        renderEditors();
                        
                        // Auto-collapse after reveal
                        setTimeout(() => {
                            const card = document.querySelector(`[data-pairing-id="${pairing.id}"]`);
                            if (card && !card.classList.contains('collapsed')) {
                                card.classList.add('collapsed');
                            }
                        }, 500);
                        
                        // Wait 1 second before next pairing
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                } catch (error) {
                    console.error(`Failed to reveal Match ${pairing.match_number}:`, error);
                    statusEl.textContent = `Error revealing Match ${pairing.match_number}`;
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            statusEl.textContent = `Successfully revealed ${pairingsToReveal.length} pairings`;
            setTimeout(() => {
                statusEl.textContent = 'Ready';
            }, 3000);
        }
        
        // Save all pairings
        async function saveAllPairings() {
            try {
                document.getElementById('global-status').textContent = 'Saving pairings...';
                
                const response = await fetch(`${CONFIG.REST_API_URL}/pairings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({ pairings })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('global-status').textContent = `Saved ${data.count} pairings`;
                    setTimeout(() => {
                        document.getElementById('global-status').textContent = 'Ready';
                    }, 2000);
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save pairings');
                document.getElementById('global-status').textContent = 'Save failed';
            }
        }
        
        // Toggle roster collapse
        function toggleRoster() {
            const roster = document.querySelector('.roster-management');
            roster.classList.toggle('collapsed');
        }
        
        // Switch roster tabs
        function switchRosterTab(team) {
            // Update tab buttons
            document.querySelectorAll('.roster-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.roster-tab.${team}`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.roster-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`roster-tab-${team}`).classList.add('active');
        }
        
        // Reset all pairings
        async function resetAllPairings() {
            if (!confirm('Reset all pairings? This will clear all player selections and reveal states.')) {
                return;
            }
            
            try {
                document.getElementById('global-status').textContent = 'Resetting pairings...';
                
                // Clear all player selections and reset reveal steps
                pairings.forEach(pairing => {
                    pairing.revealStep = 0;
                    if (pairing.type === 'team') {
                        pairing.usa_team.player1_id = '';
                        pairing.usa_team.player2_id = '';
                        pairing.intl_team.player1_id = '';
                        pairing.intl_team.player2_id = '';
                    } else {
                        pairing.usa_player_id = '';
                        pairing.intl_player_id = '';
                    }
                });
                
                // Save to backend
                await saveAllPairings();
                
                // Reset reveals on display
                await resetAllReveals();
                
                // Re-render editors
                renderEditors();
                
                document.getElementById('global-status').textContent = 'Pairings reset complete';
                setTimeout(() => {
                    document.getElementById('global-status').textContent = 'Ready';
                }, 2000);
            } catch (error) {
                console.error('Reset pairings error:', error);
                alert('Failed to reset pairings');
                document.getElementById('global-status').textContent = 'Reset failed';
            }
        }
        
        // Reset all reveals
        async function resetAllReveals() {
            if (!confirm('Reset all reveals? This will hide all pairings on the display screen.')) {
                return;
            }
            
            try {
                document.getElementById('global-status').textContent = 'Resetting...';
                
                const response = await fetch(`${CONFIG.REST_API_URL}/reveal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({ action: 'reset' })
                });
                
                if (response.ok) {
                    pairings.forEach(p => p.revealStep = 0);
                    renderEditors();
                    document.getElementById('global-status').textContent = 'Reset complete';
                    setTimeout(() => {
                        document.getElementById('global-status').textContent = 'Ready';
                    }, 2000);
                } else {
                    throw new Error('Reset failed');
                }
            } catch (error) {
                console.error('Reset error:', error);
                alert('Failed to reset reveals');
            }
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            checkSavedPassword();
        });
    </script>
</body>
</html>
